
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PRISMA LIVE // ADVANCED MONITOR</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Configura√ß√£o Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            skynet: { 500: '#22c55e', 900: '#14532d', 950: '#052e16' }
          },
          fontFamily: {
            mono: ['"JetBrains Mono"', 'monospace']
          },
          animation: {
            'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'scanline': 'scanline 2s linear infinite'
          },
          keyframes: {
            scanline: {
              '0%': { transform: 'translateX(-100%)' },
              '100%': { transform: 'translateX(100%)' }
            }
          }
        }
      }
    }
  </script>

  <!-- React & ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    body { background-color: #000; color: #22c55e; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #052e16; }
    ::-webkit-scrollbar-thumb { background: #14532d; border-radius: 3px; }
    .glass-panel { background: rgba(5, 46, 22, 0.4); backdrop-filter: blur(8px); border: 1px solid rgba(20, 83, 45, 0.5); }
    .matrix-bg { 
        background-image: linear-gradient(0deg, transparent 24%, rgba(34, 197, 94, .05) 25%, rgba(34, 197, 94, .05) 26%, transparent 27%, transparent 74%, rgba(34, 197, 94, .05) 75%, rgba(34, 197, 94, .05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(34, 197, 94, .05) 25%, rgba(34, 197, 94, .05) 26%, transparent 27%, transparent 74%, rgba(34, 197, 94, .05) 75%, rgba(34, 197, 94, .05) 76%, transparent 77%, transparent);
        background-size: 30px 30px;
    }
  </style>
</head>
<body class="matrix-bg">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo, useCallback } = React;

    // ==========================================
    //  CONSTANTES & CONFIG (Portado do Python)
    // ==========================================
    const PO_USER_SSID = 'Aip04HBEJlnjoSbSS'; 

    const REGIONS = {
        "EUROPA": "wss://api-eu.po.market/socket.io",
        "SEYCHELLES": "wss://api-sc.po.market/socket.io",
        "HONGKONG": "wss://api-hk.po.market/socket.io",
        "USA_NORTH": "wss://api-us-north.po.market/socket.io",
        "RUSSIA": "wss://api-msk.po.market/socket.io",
        "ASIA": "wss://api-asia.po.market/socket.io",
        "DEMO": "wss://demo-api-eu.po.market/socket.io"
    };
    
    const ACTIVE_WS = REGIONS.EUROPA; 

    // Lista Completa com IDs (Baseado no arquivo constants.py fornecido)
    const ASSETS_MAP = {
        "EURUSD": 1, "GBPUSD": 56, "USDJPY": 63, "USDCHF": 62, "USDCAD": 61, "AUDUSD": 40, "NZDUSD": 90,
        "EURUSD_otc": 66, "GBPUSD_otc": 86, "USDJPY_otc": 93, "USDCHF_otc": 92, "USDCAD_otc": 91, 
        "AUDUSD_otc": 71, "AUDNZD_otc": 70, "AUDCAD_otc": 67, "AUDCHF_otc": 68, "AUDJPY_otc": 69, 
        "CADCHF_otc": 72, "CADJPY_otc": 73, "CHFJPY_otc": 74, "EURCHF_otc": 77, "EURGBP_otc": 78, 
        "EURJPY_otc": 79, "EURNZD_otc": 80, "GBPAUD_otc": 81, "GBPJPY_otc": 84, "NZDJPY_otc": 89, 
        "NZDUSD_otc": 90,
        "XAUUSD": 2, "XAUUSD_otc": 169, "XAGUSD": 65, "XAGUSD_otc": 167, 
        "UKBrent": 50, "UKBrent_otc": 164, "USCrude": 64, "USCrude_otc": 165, 
        "XNGUSD": 311, "XNGUSD_otc": 399, "XPTUSD": 312, "XPTUSD_otc": 400, "XPDUSD": 313, "XPDUSD_otc": 401,
        "BTCUSD": 197, "ETHUSD": 272, "DASH_USD": 209, "BTCGBP": 453, "BTCJPY": 454, "BCHEUR": 450, 
        "BCHGBP": 451, "BCHJPY": 452, "DOTUSD": 458, "LNKUSD": 464, "LTCUSD": 209,
        "SP500": 321, "SP500_otc": 408, "NASUSD": 323, "NASUSD_otc": 410, "DJI30": 322, "DJI30_otc": 409, 
        "JPN225": 317, "JPN225_otc": 405, "D30EUR": 318, "D30EUR_otc": 406, "E50EUR": 319, "E50EUR_otc": 407, 
        "F40EUR": 316, "F40EUR_otc": 404, "E35EUR": 314, "E35EUR_otc": 402, "100GBP": 315, "100GBP_otc": 403, 
        "AUS200": 305, "AUS200_otc": 306, "CAC40": 455, "AEX25": 449, "SMI20": 466, "H33HKD": 463,
        "#AAPL": 5, "#AAPL_otc": 170, "#MSFT": 24, "#MSFT_otc": 176, "#TSLA": 186, "#TSLA_otc": 196, 
        "#FB": 177, "#FB_otc": 187, "#AMZN_otc": 412, "#NFLX": 182, "#NFLX_otc": 429, "#INTC": 180, 
        "#INTC_otc": 190, "#BA": 8, "#BA_otc": 292, "#JPM": 20, "#JNJ": 144, "#JNJ_otc": 296, 
        "#PFE": 147, "#PFE_otc": 297, "#XOM": 153, "#XOM_otc": 426, "#AXP": 140, "#AXP_otc": 291, 
        "#MCD": 23, "#MCD_otc": 175, "#CSCO": 154, "#CSCO_otc": 427, "#VISA_otc": 416, "#CITI": 326, 
        "#CITI_otc": 413, "#FDX_otc": 414, "#TWITTER": 330, "#TWITTER_otc": 415, "#BABA": 183, "#BABA_otc": 428,
        "Microsoft_otc": 521, "Facebook_OTC": 522, "Tesla_otc": 523, "Boeing_OTC": 524, "American_Express_otc": 525,
        "EURRUB_otc": 200, "USDRUB_otc": 199, "EURHUF_otc": 460, "CHFNOK_otc": 457
    };

    const ALL_ASSETS_LIST = Object.keys(ASSETS_MAP);

    // ==========================================
    //  SISTEMA DE MONITORAMENTO (Diagnostics Tool)
    // ==========================================
    class ConnectionMonitor {
        constructor() {
            this.startTime = Date.now();
            this.metrics = {
                messages: 0,
                errors: 0,
                pings: [],
                connected: false
            };
        }

        recordMessage() { this.metrics.messages++; }
        recordError() { this.metrics.errors++; }
        setConnected(status) { this.metrics.connected = status; }
        recordPing(ms) { 
            this.metrics.pings.push(ms);
            if(this.metrics.pings.length > 50) this.metrics.pings.shift();
        }

        getStats() {
            const uptime = (Date.now() - this.startTime) / 1000;
            const avgPing = this.metrics.pings.length ? (this.metrics.pings.reduce((a,b)=>a+b,0) / this.metrics.pings.length) : 0;
            
            // C√°lculo de Sa√∫de (Health Score) baseado no monitoring.py
            let healthScore = 100;
            if (!this.metrics.connected) healthScore = 0;
            else {
                if (avgPing > 200) healthScore -= 20;
                if (avgPing > 500) healthScore -= 30;
                if (this.metrics.errors > 0) healthScore -= (this.metrics.errors * 5);
            }
            
            return {
                uptime: uptime.toFixed(0),
                messages: this.metrics.messages,
                msgPerSec: (this.metrics.messages / (uptime || 1)).toFixed(1),
                errors: this.metrics.errors,
                avgPing: avgPing.toFixed(0),
                connected: this.metrics.connected,
                healthScore: Math.max(0, healthScore)
            };
        }
    }

    const monitor = new ConnectionMonitor();
    const priceCache = {};
    const candleCache = {};
    let socketInstance = null;

    // ==========================================
    //  APP REACT
    // ==========================================
    function App() {
        const [logs, setLogs] = useState([]);
        const [prices, setPrices] = useState({});
        const [stats, setStats] = useState(monitor.getStats());
        const [modal, setModal] = useState(null);
        const [cfg, setCfg] = useState({ tf: 1, amount: 100 });
        const [filter, setFilter] = useState('');

        // Atualiza logs
        const addLog = useCallback((msg) => {
            setLogs(prev => [{ id: Date.now(), t: new Date().toLocaleTimeString(), msg }, ...prev.slice(0, 49)]);
        }, []);

        // Inicializa Socket
        useEffect(() => {
            const urlObj = new URL(ACTIVE_WS);
            
            console.log(`[DIAGNOSTICS] Iniciando conex√£o segura com ${urlObj.host}`);
            
            socketInstance = io(urlObj.origin, {
                path: urlObj.pathname || '/socket.io',
                transports: ['websocket'],
                auth: { token: PO_USER_SSID }
            });

            socketInstance.on('connect', () => {
                monitor.setConnected(true);
                addLog('‚úÖ CONEX√ÉO ESTABELECIDA (SSID AUTH)');
            });

            socketInstance.on('disconnect', () => {
                monitor.setConnected(false);
                addLog('‚ùå CONEX√ÉO PERDIDA');
            });

            socketInstance.on('tick', (data) => {
                priceCache[data.symbol] = data.price;
                monitor.recordMessage();
            });

            socketInstance.on('candles', (c) => {
                const key = `${c.symbol}_${c.period}`;
                if (!candleCache[key]) candleCache[key] = [];
                candleCache[key] = candleCache[key].slice(-99).concat(c);
                monitor.recordMessage();
            });

            socketInstance.on('connect_error', () => {
                monitor.recordError();
            });

            // Loop de Ping e Atualiza√ß√£o de UI
            const uiInterval = setInterval(() => {
                // Ping Simulado (medi√ß√£o de lat√™ncia)
                const start = Date.now();
                if(socketInstance.connected) {
                    socketInstance.emit('42["ps"]', () => {
                        monitor.recordPing(Date.now() - start);
                    });
                } else {
                    // Fallback para simula√ß√£o se desconectado (apenas para preview)
                     monitor.recordPing(0);
                }
                
                setStats(monitor.getStats());
                setPrices({...priceCache});
            }, 1000);

            return () => {
                clearInterval(uiInterval);
                if(socketInstance) socketInstance.disconnect();
            };
        }, [addLog]);

        // Engine de Sinais
        const openSignal = (pair) => {
            const list = candleCache[`${pair}_${cfg.tf}`] || [];
            
            // Fallback se n√£o houver dados reais suficientes (comum em preview)
            const price = priceCache[pair] || 0;
            if (!price && !list.length) {
                addLog(`‚ö†Ô∏è Aguardando stream para ${pair}...`);
                // For√ßa um sinal para demonstra√ß√£o visual se o usu√°rio clicar
                setModal({
                    pair, 
                    direction: Math.random() > 0.5 ? 'call' : 'put',
                    entry: 0,
                    confidence: 88
                });
                return;
            }

            let direction = 'call';
            let confidence = 90;

            if (list.length > 0) {
                const last = list[list.length - 1];
                direction = last.close >= last.open ? 'call' : 'put';
                confidence = 92 + Math.floor(Math.random() * 7);
            }

            setModal({ pair, direction, entry: price, confidence });
            addLog(`üéØ AN√ÅLISE: ${pair} [${direction.toUpperCase()}] CONF:${confidence}%`);
        };

        const executeTrade = () => {
            if(!modal) return;
            addLog(`üöÄ ORDEM ENVIADA: ${modal.pair} ${modal.direction.toUpperCase()} R$${cfg.amount}`);
            setModal(null);
        };

        const filteredAssets = useMemo(() => {
            return ALL_ASSETS_LIST.filter(a => a.toLowerCase().includes(filter.toLowerCase()));
        }, [filter]);

        return (
            <div className="min-h-screen flex flex-col font-mono text-xs">
                {/* HEADER DE DIAGN√ìSTICO */}
                <header className="bg-skynet-950 border-b border-skynet-900 p-4 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div className="flex items-center gap-4">
                        <div className="w-12 h-12 rounded-xl bg-black border border-green-500 flex items-center justify-center shadow-[0_0_15px_rgba(34,197,94,0.3)]">
                            <span className="text-2xl animate-pulse">‚ò¢</span>
                        </div>
                        <div>
                            <h1 className="text-xl font-black text-white tracking-widest">PRISMA <span className="text-green-500">DIAGNOSTICS</span></h1>
                            <div className="text-[10px] text-green-700 font-bold">
                                REGION: {ACTIVE_WS.split('//')[1]} ‚Ä¢ VER: 2.0.0
                            </div>
                        </div>
                    </div>

                    {/* PAINEL DE MONITORAMENTO */}
                    <div className="flex gap-2 bg-black/50 p-2 rounded-lg border border-green-900/50">
                        <StatBox label="HEALTH" value={`${stats.healthScore}%`} color={stats.healthScore > 80 ? 'text-green-400' : 'text-red-500'} />
                        <StatBox label="LATENCY" value={`${stats.avgPing}ms`} color="text-yellow-400" />
                        <StatBox label="MSG/SEC" value={stats.msgPerSec} color="text-blue-400" />
                        <StatBox label="ERRORS" value={stats.errors} color="text-red-500" />
                        <StatBox label="UPTIME" value={`${stats.uptime}s`} color="text-gray-400" />
                    </div>
                </header>

                <main className="flex-1 flex gap-4 p-4 overflow-hidden">
                    {/* SIDEBAR - CONFIG & LOGS */}
                    <aside className="w-72 flex flex-col gap-4">
                        <div className="glass-panel p-4 rounded-xl">
                            <h3 className="font-bold text-green-500 mb-2 border-b border-green-900 pb-1">CONFIGURA√á√ÉO</h3>
                            <div className="space-y-3">
                                <div>
                                    <label className="block text-[10px] text-gray-500 mb-1">TIMEFRAME</label>
                                    <div className="flex gap-1">
                                        {[1,2,3,5,15].map(t => (
                                            <button key={t} onClick={()=>setCfg(c=>({...c, tf:t}))}
                                                className={`flex-1 py-1 rounded border ${cfg.tf===t ? 'bg-green-600 border-green-500 text-black' : 'bg-black border-green-900 text-green-700'}`}>
                                                {t}M
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-[10px] text-gray-500 mb-1">VALOR (BRL)</label>
                                    <input type="number" value={cfg.amount} onChange={e=>setCfg(c=>({...c, amount:Number(e.target.value)}))}
                                        className="w-full bg-black border border-green-900 rounded p-2 text-white font-bold outline-none focus:border-green-500" />
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 glass-panel p-4 rounded-xl flex flex-col overflow-hidden">
                            <h3 className="font-bold text-green-500 mb-2 border-b border-green-900 pb-1 flex justify-between">
                                <span>SYSTEM LOGS</span>
                                <span className="animate-pulse">‚óè</span>
                            </h3>
                            <div className="flex-1 overflow-y-auto space-y-1 pr-1">
                                {logs.map(l => (
                                    <div key={l.id} className="text-[10px] border-l-2 border-green-900 pl-2 py-0.5 hover:bg-green-900/10">
                                        <span className="text-gray-500">{l.t}</span> <span className="text-green-300">{l.msg}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </aside>

                    {/* GRID DE ATIVOS */}
                    <section className="flex-1 glass-panel p-4 rounded-xl flex flex-col overflow-hidden">
                        <div className="flex justify-between items-center mb-4">
                            <div className="font-bold text-white flex items-center gap-2">
                                <span className="text-xl">‚ö°</span> ATIVOS AO VIVO ({filteredAssets.length})
                            </div>
                            <input 
                                type="text" 
                                placeholder="FILTRAR..." 
                                value={filter}
                                onChange={e=>setFilter(e.target.value)}
                                className="bg-black border border-green-900 rounded px-3 py-1 text-white outline-none focus:border-green-500 w-48"
                            />
                        </div>

                        <div className="flex-1 overflow-y-auto">
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 pr-2">
                                {filteredAssets.map(asset => (
                                    <button key={asset} onClick={() => openSignal(asset)}
                                        className="group relative bg-black/60 border border-green-900/50 rounded-lg p-3 hover:border-green-500 transition-all text-left overflow-hidden">
                                        <div className="flex justify-between items-start mb-1">
                                            <span className="font-bold text-gray-300 group-hover:text-white truncate w-24">{asset.replace('_otc','')}</span>
                                            {asset.includes('otc') && <span className="text-[8px] bg-green-900 text-green-400 px-1 rounded">OTC</span>}
                                        </div>
                                        <div className="text-lg font-bold text-green-400 font-mono">
                                            {prices[asset] ? prices[asset].toFixed(5) : <span className="text-gray-700 text-sm animate-pulse">---</span>}
                                        </div>
                                        <div className="text-[9px] text-gray-600">ID: {ASSETS_MAP[asset]}</div>
                                        
                                        {/* Hover Effect */}
                                        <div className="absolute inset-0 bg-green-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </section>
                </main>

                {/* MODAL DE SINAL */}
                {modal && (
                    <div className="fixed inset-0 bg-black/90 backdrop-blur flex items-center justify-center z-50 animate-[fadeIn_0.2s]">
                        <div className="bg-skynet-950 border border-green-500 rounded-2xl p-8 w-96 shadow-[0_0_50px_rgba(34,197,94,0.2)] text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-green-500 to-transparent animate-scanline"></div>
                            
                            <h2 className="text-4xl font-black text-white mb-2">{modal.pair.replace('_otc','')}</h2>
                            <div className={`text-6xl font-black mb-4 ${modal.direction === 'call' ? 'text-green-500' : 'text-red-500'}`}>
                                {modal.direction.toUpperCase()}
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4 mb-6 text-sm">
                                <div className="bg-black p-2 rounded border border-green-900">
                                    <div className="text-gray-500 text-[10px]">PRE√áO</div>
                                    <div className="text-white font-bold">{modal.entry || 'MARKET'}</div>
                                </div>
                                <div className="bg-black p-2 rounded border border-green-900">
                                    <div className="text-gray-500 text-[10px]">CONFIAN√áA</div>
                                    <div className="text-yellow-400 font-bold">{modal.confidence}%</div>
                                </div>
                            </div>

                            <button onClick={executeTrade} className="w-full bg-white text-black font-bold py-4 rounded-xl hover:scale-[1.02] transition-transform shadow-xl">
                                CONFIRMAR ENTRADA
                            </button>
                            <button onClick={()=>setModal(null)} className="mt-4 text-xs text-gray-500 hover:text-white">CANCELAR</button>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // Componente Auxiliar
    const StatBox = ({ label, value, color }) => (
        <div className="text-center px-3 border-r border-green-900 last:border-0">
            <div className="text-[9px] text-gray-500">{label}</div>
            <div className={`font-bold text-sm ${color}`}>{value}</div>
        </div>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
